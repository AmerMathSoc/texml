\ProvidesPackage{chapauthor}[2025/02/13 v1.02]

\RequirePackage{iftexml}

\newcommand{\sectionauthor}[1]{\noindent by #1\par}

\let\@authorlist\@empty
\let\@authorname\relax
\let\@authornote\relax

\newcommand{\chapterauthor}[1]{%
    \ifx\@authorlist\@empty
        \gdef\@authorlist{\@authorname{#1}}%
    \else
        \g@addto@macro\@authorlist{\and\@authorname{#1}}%
    \fi
}

\newcommand{\chapterauthornote}[1]{%
    \g@addto@macro\@authorlist{\@authornote{#1}}%
}

\newcommand{\chaptertitle}[2][]{%
  \def\@chaptershorttitle{#1}%
  \def\@chaptertitle{#2}%
  \ifx\@chaptershorttitle\@empty
      \let\@chaptershorttitle\@chaptertitle
  \fi
}
\newcommand{\chaptersubtitle}{\def\@chaptersubtitle}

\let\@chaptertitle\@empty
\let\@chaptershorttitle\@empty
\let\@chaptersubtitle\@empty

\newbox\abstractbox
\renewenvironment{abstract}{%
  % \ifx\maketitle\relax
  %   \ClassWarning{\@classname}{Abstract should precede
  %     \protect\maketitle\space in AMS document classes; reported}%
  % \fi
    \global\setbox\abstractbox=\vtop \bgroup
        \normalfont
        \list{}{%
            \labelwidth\z@
            \leftmargin2pc
            \rightmargin\leftmargin
            \listparindent\normalparindent
            \itemindent\z@
            \parsep\z@ \@plus\p@
            \let\fullwidthdisplay\relax
        }%
        \item[\hskip\labelsep\normalfont\sffamily\bfseries\large\abstractname.\enskip]%
}{%
        \endlist
    \egroup
}

\def\typeset@author#1{%
    \begingroup
        \let\\\typeset@affil
        \par#1\@empty
    \endgroup
}

\def\typeset@affil#1\@empty{%
    , {\mdseries\itshape\ignorespaces#1}%
}

\def\tocauthors#1{%
  \unskip{\mdseries\itshape#1}
}

\def\prep@author#1{#1\@empty}

\def\strip@affil#1\@empty{}

\let\sectionmark\@gobble

\def\swap@meaning#1#2{%
    \let\@gtempa#1%
    \let#1#2%
    \let#2\@gtempa
}

\def\bb@space{%
    \ifdim\lastskip>\z@
        \vskip-\lastskip
    \fi
    \begingroup
        \@ifstar{\baselineskip\normalbaselineskip\bb@space@}\bb@space@
}

\def\bb@space@{%
        \afterassignment\bb@space@@
        \skip@=
}

\def\bb@space@@{%
        \advance\skip@-\baselineskip
        \vskip\skip@
    \endgroup
}

\newcommand{\makechaptertitle}{%
    \cleardoublepage
    \thispagestyle{plain}%
    \global\@topnum\z@
    \@afterindentfalse
    \ifx\@chaptertitle\@empty
        \PackageError{chapauthor}{No title!}\@ehd
    \else
        \refstepcounter{chapter}%
        \let\@secnumber\thechapter
        \typeout{\chaptername\space\@secnumber}%
        \def\@toclevel{0}%
        \begingroup
            \ifx\@authorlist\@empty\else
                \swap@meaning\\\strip@affil
                \let\@authorname\prep@author
                \let\and\relax
                \protected@edef\@authorlist{\@authorlist}%
                \swap@meaning\\\strip@affil
                \author@andify\@authorlist
                \protected@edef\@chaptertitle{%
                    \@chaptertitle
                }%
            \fi
            \protected@edef\@tempa{%
                \noexpand\@tocwriteb\noexpand\tocchapter{chapter}{\@chaptertitle}%
                \ifx\@authorlist\@empty\else
                  \noexpand\protect\noexpand\addtocontents{toc}{\protect\contentsline{section}{\tocauthors{\@authorlist}}{}{}}%
                 \fi
            }%
            \@tempa
        \endgroup
        \begingroup
            \@xp\markleft\@xp{\@chaptershorttitle}%
            \ifx\@authorlist\@empty\else
                \author@andify\@authorlist
                \protected@edef\@authorlist{\@authorlist}
                \@xp\markright\@xp{\protect\chapterrunhead{}{}{\@authorlist}}%
            \fi
        \endgroup
        \ifx\@chaptersubtitle\@empty\else
            \protected@edef\@chaptertitle{\@chaptertitle: \@chaptersubtitle}%
        \fi
        \protected@edef\@tempa{%
            \noexpand\@makechapterhead{\@chaptertitle}%
        }%
        \@tempa
    \fi
    \ifx\@authorlist\@empty\else
        \bb@space 3.5pc
        \begin{flushright}%
            \sffamily\bfseries
            \fontsize{12}{18}\selectfont
            \let\@authorname\typeset@author
            \let\@authornote\@authorname
            \author@andify\@authorlist
            \@authorlist
        \end{flushright}
        \bb@space 4.5pc
    \fi
    \@setabstracta
    \let\@authorlist\@empty
    \let\@chaptertitle\@empty
    \let\@chaptersubtitle\@empty
    \@afterheading
}

\def\@setabstracta{%
    \ifvoid\abstractbox \else
        \unvbox\abstractbox
  \fi
}

\providecommand{\xandlist}[4]{\@andlista{{#1}{#2}{#3}}#4\and\and}

\def\@andlista#1#2\and#3\and{%
    \@andlistc{#2}%
    \@ifnotempty{#3}{\@andlistb#1{#3}}%
}

\def\@andlistb#1#2#3#4#5\and{%
    \@ifempty{#5}{%
        \@andlistc{#2#4}%
    }{%
        \@andlistc{#1#4}\@andlistb{#1}{#3}{#3}{#5}%
    }%
}

\let\@andlistc\@iden
%    \end{macrocode}
%    \end{macro}
%
%    \begin{macro}{\nxandlist}
%    This is a `no-execute' version of \cs{\xandlist} whose fourth
%    argument should be a macro; the text to be converted will be
%    taken from that macro and after conversion will be put back as
%    the macro's new replacement text.
%    \begin{macrocode}
\providecommand{\nxandlist}[4]{%
    \def\@andlistc##1{\toks@\@xp{\the\toks@##1}}%
    \toks@{\toks@\@emptytoks \@andlista{{#1}{#2}{#3}}}%
    \the\@xp\toks@#4\and\and
    \edef#4{\the\toks@}%
    \let\@andlistc\@iden
}
%    \end{macrocode}
%    \end{macro}
%
%  \begin{macro}{andify}
%    The \cs{andify} function is provided as a convenient abbreviation
%    for the most common case.  See also \cs{author@andify} (for
%    \cls{amsart} and \cls{amsproc} only), which gives better results
%    in cases with a large number of authors.  Provide a substitutable
%    text string to simplify language-specific modifications.
%    \begin{macrocode}
\def\@@and{and}

\providecommand{\andify}{%
    \nxandlist{\unskip, }{\unskip{} \@@and~}{\unskip, \@@and~}%
}
%    \end{macrocode}
%    Override the funny default definition of \cn{and} from \latex/.
%    This is not actually used by AMS classes, however.
%    \begin{macrocode}
\def\and{\unskip{ }\@@and{ }\ignorespaces}

\def\author@andify{%
    \nxandlist {\unskip ,\space\ignorespaces}%
               {\unskip {} \@@and~}%
               {\unskip ,\space \@@and~}%
}

\endinput
