%% AMS prddvilualatex

\documentclass{amsbook}

\usepackage{texml}

\title{listoffigures}

\csname noTeXMLhistory\endcsname

\usepackage{float}

\ifTeXML
    \makeatletter
    \def\@caption#1[#2]#3{%
        \ifst@rred\else
            %%
            %% Try very very hard not to output an empty <label/>
            %%
            %% Use a dedicated \@temp macro here because cleveref steals
            %% \@tempa in its redefinition of \refstepcounter
            %%
            \expandafter\ifx\csname the#1\endcsname \@empty \else
                \refstepcounter{#1}%
            \fi
            \@ifundefined{fnum@#1}{%
                % old-style
                \protected@edef\@templabel{\csname #1name\endcsname}%
                \expandafter\ifx\csname the#1\endcsname \@empty \else
                    \ifx\@templabel\@empty\else
                        \protected@edef\@templabel{\@templabel\space}%
                    \fi
                    \protected@edef\@templabel{\@templabel\csname the#1\endcsname}%
                \fi
            }{%
                % \newfloat
                \protected@edef\@templabel{\@nameuse{fnum@#1}}%
            }%
            \ifx\@templabel\@empty\else
                \startXMLelement{label}%
                \ignorespaces\@templabel\unskip
                \endXMLelement{label}%
                \addcontentsline{\csname ext@#1\endcsname}{#1}{%
                    \protect\numberline{}{\csname the#1\endcsname}%
                                       {#2}%
                                       {\@currentXMLid}%
                }%
            \fi
        \fi
        \if###3##\else
            \par
            \begingroup
                \def\jats@graphics@element{inline-graphic}
                \xmlpartag{p}%
                \startXMLelement{caption}%
                    #3\par
                \endXMLelement{caption}%
                \par
            \endgroup
        \fi
    }
    \def\listoffigures{%
        \@starttoc@list{lof}\listfigurename
    }
    \let\l@figure\@firstoftwo
    \def\listoftables{%
        \@starttoc@list{lot}\listtablename
    }
    \let\l@table\l@figure
    \def\tableofcontents{%
        \makededication
        \@starttoc{toc}\contentsname
        % Need to find a different way to handle \insertAMSDRMstatement
        % \insertAMSDRMstatement
    }
    \makeatother
\fi

\begin{document}

\frontmatter

\maketitle

\tableofcontents

\listoffigures

\listoftables

\csname insertAMSDRMstatement\endcsname

\mainmatter

\chapter{First Chapter with math $x$}
\label{chap:1}

\begin{figure}[H]
\caption{Here's a figure in chapter 1.}
\label{fig:1}
\end{figure}

See figure~\ref{fig:1}.

\chapter{Second Chapter}
\label{chap:2}

\section{Section 2.1}

\chapter{Third Chapter}

\begin{figure}[H]
\caption{Here's a figure in chapter 3.}
\end{figure}

\section{Here is a section $e = mc^2$}

\begin{table}[H]
\caption{Here's a table.}
\end{table}

\section{Here is a section \ref{chap:1} with a reference}

\section{Here is a footnote \protect\footnote{with a footnote}}

\begin{figure}[H]
\caption{Here's another figure in chapter 3.}
\end{figure}

\chapter{Fourth Chapter}

\end{document}
