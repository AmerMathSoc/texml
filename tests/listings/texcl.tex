\documentclass{amsart}

\csname noTeXMLhistory\endcsname

\nofiles

\usepackage{texml}

\ifTeXML
    \usepackage{Listings}
    \def\comment{\XMLelement{comment}}
\else
    \usepackage{listings}
    \def\comment#1{{\color{green}#1}}
\fi

\usepackage{xcolor}

\title{listings}

\begin{document}

\lstset{
    numbers=left,
    comment=[l]{//},
    morecomment=[l]{\#},
    morecomment=[s]{/*}{*/},
    morecomment=[n]{(*}{*)},
    commentstyle=\comment,
}

mathescape=false; texcl=false

\begin{lstlisting}
    for ($e=mc^2$)

    A // $e=mc^2$

    # comment: $e=mc^2$

    /* C-style comment: $e=mc^2$ */

    /* Non-/*nesting*/ comment: $e=mc^2$ */

    (* nested (* comment $e=mc^2$ *) *)
\end{lstlisting}

\bigskip

\bigskip

mathescape=false; texcl=true

\begin{lstlisting}[texcl]
    for ($e=mc^2$)

    A // $e=mc^2$

    # comment: $e=mc^2$

    /* C-style comment: $e=mc^2$ */

    /* Non-/*nesting*/ comment: $e=mc^2$ */

    (* nested (* comment $e=mc^2$ *) *)
\end{lstlisting}

\bigskip

\bigskip

\newpage

mathescape=true; texcl=false

\begin{lstlisting}[mathescape]
    for ($e=mc^2$)

    A // $e=mc^2$

    # comment: $e=mc^2$

    /* C-style comment: $e=mc^2$ */

    /* Non-/*nesting*/ comment: $e=mc^2$ */

    (* nested (* comment $e=mc^2$ *) *)
\end{lstlisting}

\bigskip

\bigskip

mathescape=true; texcl=true

\begin{lstlisting}[texcl,mathescape]
    for ($e=mc^2$)

    A // $e=mc^2$

    # comment: $e=mc^2$

    /* C-style comment: $e=mc^2$ */

    /* Non-/*nesting*/ comment: $e=mc^2$ */

    (* nested (* comment $e=mc^2$ *) *)
\end{lstlisting}

\end{document}
